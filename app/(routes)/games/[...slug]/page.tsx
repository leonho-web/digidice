import { Suspense } from "react";
import { Metadata } from "next";
import { generateSEOMetadata } from "@/lib/utils/seo/seo-provider";
import { GamesPageLayoutWrapper } from "./games-page-layout-wrapper";
import { QueryPageSkeleton } from "@/components/features/query-display/query-page-skeleton";
import { interpolateSiteName } from "@/lib/utils/site-config";
import {
	CATEGORY_TO_SLUG,
	PROVIDER_SLUG_MAP,
} from "@/lib/utils/provider-slug-mapping";
import { knownCategorySlugs } from "@/data/top-providers";

interface PageProps {
	params: Promise<{ slug: string[] }>;
}

export async function generateMetadata({
	params,
}: PageProps): Promise<Metadata> {
	const { slug } = await params;
	const { slugToProviderDisplayName, slugToCategory } = await import(
		"@/lib/utils/provider-slug-mapping"
	);
	const siteName = interpolateSiteName(`{siteName}`);

	// Known category slugs for checking if single slug is a category

	if (slug.length === 1) {
		const decodedSlug = decodeURIComponent(slug[0]).toLowerCase();

		// Check if it's a category-only URL: /games/slot or /games/live-casino
		if (knownCategorySlugs.includes(decodedSlug)) {
			const category = slugToCategory(decodedSlug);
			console.log({
				category_to_slug: CATEGORY_TO_SLUG[category],
				category,
			});
			const categoryName = category || CATEGORY_TO_SLUG[category];

			return generateSEOMetadata({
				title: `${categoryName} - Best Crypto ${categoryName} Games 2025 | ${siteName}`,
				description: `Play the best ${categoryName} games on ${siteName} - the leading provably fair crypto casino. Instant withdrawals, no KYC, Bitcoin & Ethereum accepted. 1000+ ${categoryName} games from top providers.`,
				keywords: [
					`crypto ${categoryName}`,
					`Bitcoin ${categoryName}`,
					`${categoryName} provably fair`,
					"crypto casino games",
					"blockchain gaming",
					"instant withdrawal casino",
					"no KYC casino",
					"Bitcoin gambling",
				],
				path: `/games/${slug[0]}`,
				pageType: "game",
				ogType: "website",
			});
		}

		// Provider only: /games/pg-soft or /games/pragmatic-play
		const providerName = slugToProviderDisplayName(
			decodeURIComponent(slug[0])
		);

		return generateSEOMetadata({
			title: `${providerName} Games - Provably Fair Crypto Casino | ${siteName}`,
			description: `Explore all ${providerName} games on BetFlux. Play slots, live casino, and more from ${providerName} with amazing features and big wins`,
			keywords: [
				providerName,
				"games",
				"casino games",
				"online slots",
				"live casino",
			],
			path: `/games/${slug[0]}`,
			pageType: "game",
			ogType: "website",
		});
	} else if (slug.length === 2) {
		// Provider + category: /games/pg-soft/slot or /games/pragmatic-play/slot
		const providerName = slugToProviderDisplayName(
			decodeURIComponent(slug[0])
		);
		const category = slugToCategory(decodeURIComponent(slug[1]));

		// Use friendly category names
		const categoryMap: Record<string, string> = {
			SLOT: "Slot",
			"LIVE CASINO": "Live Casino",
			"SPORT BOOK": "Sports",
			SPORTSBOOK: "Sports",
			RNG: "Table",
		};
		const categoryName =
			categoryMap[category] ||
			category.charAt(0).toUpperCase() + category.slice(1).toLowerCase();

		return generateSEOMetadata({
			title: `${providerName} ${categoryName} Games - BetFlux`,
			description: `Play ${categoryName} games from ${providerName} on BetFlux. Enjoy the best ${categoryName} gaming experience with top features and rewards.`,
			keywords: [
				providerName,
				categoryName,
				"games",
				"casino",
				"online gaming",
			],
			path: `/games/${slug[0]}/${slug[1]}`,
			pageType: "game",
			ogType: "website",
		});
	}

	// Fallback
	return generateSEOMetadata({
		title: `Games - ${siteName}`,
		description: `Explore all games on ${siteName}`,
		keywords: ["games", "casino", "online gaming"],
		path: "/games",
		pageType: "game",
		ogType: "website",
	});
}

export default async function DynamicGamesPage({ params }: PageProps) {
	const { slug } = await params;

	return (
		<Suspense fallback={<QueryPageSkeleton />}>
			<GamesPageLayoutWrapper slug={slug} />
		</Suspense>
	);
}

// Generate static params for ALL providers and categories (SEO optimization)
export function generateStaticParams() {
	// Get all unique provider slugs (69 providers)
	const allProviderSlugs = Object.keys(PROVIDER_SLUG_MAP).filter(
		// Filter out aliases to avoid duplicates
		(slug) =>
			!["relax-gaming", "hacksaw-gaming", "nolimit-city"].includes(slug)
	);

	const categories = ["slot", "live-casino", "sports", "rng"];

	const params = [];

	// Generate category-only pages (SEO important!)
	for (const category of categories) {
		params.push({ slug: [category] });
	}

	// Generate provider-only pages for top 50 providers (SEO focus)
	const topProviders = [
		"pg-soft",
		"pragmatic-play",
		"evolution",
		"netent",
		"ka-gaming",
		"playtech",
		"microgaming",
		"habanero",
		"red-tiger",
		"yggdrasil",
		"sa-gaming",
		"jili",
		"cq9",
		"jdb",
		"live22",
		"booongo",
		"btg",
		"relax",
		"no-limit",
		"fa-chai",
		...allProviderSlugs.slice(0, 30), // Add more providers
	];

	// Provider only pages (50 providers)
	for (const provider of topProviders) {
		params.push({ slug: [provider] });
	}

	// Provider + category pages (top 20 providers Ã— 4 categories = 80 pages)
	const topProvidersForCategories = topProviders.slice(0, 20);
	for (const provider of topProvidersForCategories) {
		for (const category of categories) {
			params.push({ slug: [provider, category] });
		}
	}

	// Total: ~130 static pages for maximum SEO coverage
	return params;
}
